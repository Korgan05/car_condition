<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Car Condition</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; background: #0b1020; color: #eaeef3; margin: 0; }
    header { padding: 16px 24px; background: #121833; font-weight: 600; }
    main { max-width: 900px; margin: 24px auto; padding: 16px; background: #141a3a; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.25); }
    .row { display: flex; gap: 24px; flex-wrap: wrap; }
    .card { flex: 1 1 340px; background: #0f1430; border: 1px solid #242a52; border-radius: 12px; padding: 16px; }
    h1 { margin: 0 0 12px; font-size: 20px; }
    h2 { margin: 0 0 8px; font-size: 16px; color: #a8b0d8; }
    input[type=file] { padding: 8px; }
    button { background: #3b82f6; color: white; border: none; padding: 10px 16px; border-radius: 8px; cursor: pointer; }
    button:disabled { opacity: 0.6; cursor: progress; }
    .result { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; background: #0a0f2b; border: 1px solid #272f5d; border-radius: 8px; padding: 12px; white-space: pre-wrap; }
    .grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
    .badge { display: inline-block; padding: 4px 8px; border-radius: 999px; background: #1f2a5a; border: 1px solid #2f3a7a; }
    .badge.ok { background: #103c2b; border-color: #1f6d4b; }
    .badge.bad { background: #3c1010; border-color: #6d1f1f; }
    .file { font-weight: 600; margin-bottom: 6px; color: #c9d4ff; }
    .line { display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-bottom:10px; }
  </style>
</head>
<body>
  <header>Состояние авто — чистота и повреждения</header>
  <main>
    <div class="row">
      <div class="card">
  <h1>Загрузка фото</h1>
  <p>Загрузите одно или несколько изображений автомобиля (JPG/PNG/BMP).</p>
  <input id="fileInput" type="file" accept="image/*" multiple />
        <div style="height: 12px;"></div>
  <button id="sendBtn">Отправить</button>
        <div style="height: 12px;"></div>
        <label style="display:inline-flex; gap:8px; align-items:center;">
          <input id="showCam" type="checkbox" /> Показать тепловые карты на фото (грязь и повреждения)
        </label>
        <div style="height: 12px;"></div>
        <label style="display:inline-flex; gap:8px; align-items:center;">
          <input id="showDet" type="checkbox" /> Детекция повреждений (YOLO) — отрисовать боксы
        </label>
        <div style="height: 12px;"></div>
      </div>
      <div class="card">
  <h1>Результаты</h1>
        <div id="meta" style="margin-bottom:8px; color:#8ea0d0; font-size:12px;"></div>
  <div id="preview"></div>
        <div style="height: 12px;"></div>
  <div id="labels" class="grid"></div>
        <div style="height: 12px;"></div>
      </div>
    </div>
  </main>
  <script>
    const input = document.getElementById('fileInput');
    const btn = document.getElementById('sendBtn');
    const preview = document.getElementById('preview');
  const labels = document.getElementById('labels');
  const meta = document.getElementById('meta');
  const showCam = document.getElementById('showCam');
  const showDet = document.getElementById('showDet');
    // load metadata
    fetch('/api/metadata').then(r=>r.json()).then(m=>{
      const yolo = m.yolo_loaded && m.yolo_weights ? ` | YOLO: ${m.yolo_weights}` : '';
      meta.textContent = `модель: ${m.backbone}${yolo}`;
    }).catch(()=>{});
    // убрали тех. JSON — оставляем только человеко-понятные подписи

    input.addEventListener('change', () => {
      preview.innerHTML = '';
      if (!input.files?.length) return;
      [...input.files].slice(0, 6).forEach((f, idx) => {
        const img = document.createElement('img');
        img.style.maxWidth = '100%';
        img.style.borderRadius = '8px';
        img.style.marginBottom = '8px';
        img.dataset.idx = String(idx);
        img.src = URL.createObjectURL(f);
        preview.appendChild(img);
        // контейнер для детекций и карт
        const info = document.createElement('div');
        info.className = 'result';
        info.style.margin = '8px 0 12px 0';
        info.id = `info-${idx}`;
        preview.appendChild(info);
      });
    });

    btn.addEventListener('click', async () => {
      if (!input.files?.length) return alert('Выберите файл(ы)');
      btn.disabled = true; btn.textContent = 'Загрузка…';
      try {
        const fd = new FormData();
        [...input.files].forEach(f => fd.append('files', f));
  const resp = await fetch('/api/batch_predict', { method: 'POST', body: fd });
        if (!resp.ok) throw new Error(await resp.text());
  const data = await resp.json();

  labels.innerHTML = '';
        if (data?.results?.length) {
          data.results.forEach(item => {
            const wrap = document.createElement('div');
            wrap.className = 'line';
            if (item.error) {
              const err = document.createElement('div');
              err.className = 'badge bad';
              err.textContent = `❌ ${item.filename || ''}: ${item.error}`;
              wrap.appendChild(err);
              labels.appendChild(wrap);
              return;
            }

            // Используем решения сервера (автопороги из чекпойнта)
            let cleanLabel = item.pred_clean_ru || (item.pred_clean === 'clean' ? 'чистый' : 'грязный');
            let damageLabel = item.pred_damage_ru || (item.pred_damage === 'damaged' ? 'битый' : 'целый');

            const title = document.createElement('div');
            title.className = 'file';
            title.textContent = item.filename || '';
            labels.appendChild(title);

            const dirtBadge = document.createElement('span');
            const dmgBadge = document.createElement('span');

            // Вердикты в явном виде
            const dirtIsClean = (cleanLabel === 'чистый');
            dirtBadge.className = 'badge ' + (dirtIsClean ? 'ok' : 'bad');
            dirtBadge.textContent = dirtIsClean ? 'Грязь: нет' : 'Грязь: есть';

            const dmgIsDamaged = (damageLabel === 'битый');
            dmgBadge.className = 'badge ' + (dmgIsDamaged ? 'bad' : 'ok');
            dmgBadge.textContent = dmgIsDamaged ? 'Повреждения: есть' : 'Повреждения: нет';

            wrap.appendChild(dirtBadge);
            wrap.appendChild(dmgBadge);
            labels.appendChild(wrap);
          });
        }

        // Grad-CAM: строим две карты (грязь и повреждения)
        if (showCam.checked) {
          // Очистим прошлые карты
          [...preview.querySelectorAll('img.cam,canvas.cam')].forEach(n => n.remove());
          for (let i = 0; i < Math.min(input.files.length, 6); i++) {
            const f = input.files[i];
            // Если далее будем рисовать боксы, заранее получим детекции (1 раз на файл)
            let detections = [];
            if (showDet.checked) {
              try {
                const fdDet = new FormData();
                fdDet.append('file', f);
                const rDet = await fetch('/api/detect', { method: 'POST', body: fdDet });
                if (rDet.ok) {
                  const detJson = await rDet.json();
                  detections = detJson?.detections || [];
                  // Обновим список детекций под исходным предпросмотром
                  const info = document.getElementById(`info-${i}`) || document.createElement('div');
                  info.className = info.className || 'result';
                  const lines = detections.map(d => {
                    const cls = d.class || 'объект';
                    const s = Math.round((d.score || 0) * 100);
                    return `• ${cls} — ${s}%`;
                  });
                  info.textContent = lines.length ? lines.join('\n') : 'Объекты не найдены';
                  if (!info.id) { info.id = `info-${i}`; preview.appendChild(info); }
                }
              } catch (e) {
                console.warn('Detect json error', e);
              }
            }

            for (const head of ['dirty','damaged']) {
              const fd2 = new FormData();
              fd2.append('file', f);
              try {
                const r2 = await fetch(`/api/heatmap?head=${head}`, { method: 'POST', body: fd2 });
                if (!r2.ok) throw new Error(await r2.text());
                const blob = await r2.blob();
                const url = URL.createObjectURL(blob);

                // Рендер в canvas, чтобы нарисовать поверх боксы
                const img = new Image();
                img.onload = () => {
                  const canvas = document.createElement('canvas');
                  canvas.className = 'cam';
                  canvas.width = img.naturalWidth;
                  canvas.height = img.naturalHeight;
                  canvas.style.maxWidth = '100%';
                  canvas.style.borderRadius = '8px';
                  canvas.style.margin = '4px 0 12px 0';
                  const ctx = canvas.getContext('2d');
                  if (!ctx) return;
                  ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

                  // Если нужно, поверх теплокарты рисуем детекции
                  if (showDet.checked && detections.length) {
                    ctx.lineWidth = Math.max(2, Math.round(Math.min(canvas.width, canvas.height) * 0.003));
                    ctx.strokeStyle = '#ffd54a';
                    ctx.fillStyle = 'rgba(0,0,0,0.6)';
                    ctx.font = `${Math.max(12, Math.round(canvas.width * 0.018))}px system-ui, Arial`;
                    ctx.textBaseline = 'top';
                    detections.forEach(d => {
                      const [x1, y1, x2, y2] = d.box || [];
                      if ([x1,y1,x2,y2].some(v => typeof v !== 'number')) return;
                      const w = x2 - x1, h = y2 - y1;
                      // рамка
                      ctx.strokeRect(x1, y1, w, h);
                      // подпись
                      const label = `${d.class || ''} ${(d.score!=null?Math.round(d.score*100):'') || ''}%`.trim();
                      const tw = ctx.measureText(label).width;
                      const th = Math.max(18, Math.round(canvas.width * 0.028));
                      const bx = Math.max(0, x1);
                      const by = Math.max(0, y1 - th);
                      ctx.fillStyle = 'rgba(0,0,0,0.6)';
                      ctx.fillRect(bx, by, tw + 8, th);
                      ctx.fillStyle = '#ffd54a';
                      ctx.fillText(label, bx + 4, by + 2);
                      ctx.strokeStyle = '#ffd54a';
                    });
                  }

                  const cap = document.createElement('div');
                  cap.style.fontSize = '12px';
                  cap.style.color = '#8ea0d0';
                  cap.textContent = head === 'dirty' ? 'Теплокарта: Грязь (с боксами)' : 'Теплокарта: Повреждения (с боксами)';
                  preview.appendChild(cap);
                  preview.appendChild(canvas);
                };
                img.src = url;
              } catch (e) {
                console.warn('CAM error', head, e);
              }
            }
          }
        }

        // YOLO детекция (аннотированная картинка), если теплокарты НЕ включены
        if (showDet.checked && !showCam.checked) {
          [...preview.querySelectorAll('img.det')].forEach(n => n.remove());
          for (let i = 0; i < Math.min(input.files.length, 3); i++) {
            const f = input.files[i];
            const fd3 = new FormData();
            fd3.append('file', f);
            try {
              // Annotated image
              const r3 = await fetch('/api/detect_image', { method: 'POST', body: fd3 });
              if (!r3.ok) throw new Error(await r3.text());
              const blob = await r3.blob();
              const url = URL.createObjectURL(blob);
              const img = document.createElement('img');
              img.className = 'det';
              img.style.maxWidth = '100%';
              img.style.border = '1px solid #2f3a7a';
              img.style.borderRadius = '8px';
              img.style.margin = '4px 0 6px 0';
              img.src = url;
              preview.appendChild(img);

              // Detection list (class + score)
              const r4 = await fetch('/api/detect', { method: 'POST', body: fd3 });
              if (r4.ok) {
                const det = await r4.json();
                const info = document.getElementById(`info-${i}`) || document.createElement('div');
                info.className = info.className || 'result';
                const lines = (det?.detections || []).map(d => {
                  const cls = d.class || 'объект';
                  const s = Math.round((d.score || 0) * 100);
                  return `• ${cls} — ${s}%`;
                });
                info.textContent = lines.length ? lines.join('\n') : 'Объекты не найдены';
                if (!info.id) { info.id = `info-${i}`; preview.appendChild(info); }
              }
            } catch (e) {
              console.warn('Detect error', e);
            }
          }
        }
      } catch (e) {
        alert('Ошибка: ' + e);
      } finally {
        btn.disabled = false; btn.textContent = 'Отправить';
      }
    });
  </script>
</body>
</html>
